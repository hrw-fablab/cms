{% load wagtailcore_tags wagtailroutablepage_tags %}
{% block content %}
    <div class="fl-content fl-calendar" id="calendar" data-width="large">
        <header class="margin" data-margin="block-end" data-margin-size="tiny">
            <time id="date"></time>
            <div class="fl-flex gap" data-gap="small">
                <button id="backward">
                    <svg width="20" height="20" viewBox="0 0 24 24" transform="rotate(90)">
                        <path d="M2.6 5.1.1 7.6 9.5 17l2.5 2.5 2.5-2.5 9.4-9.4-2.5-2.5-9.4 9.4-9.4-9.4z"/>
                    </svg>
                </button>
                <button id="forward">
                    <svg width="20" height="20" viewBox="0 0 24 24" transform="rotate(-90)">
                        <path d="M2.6 5.1.1 7.6 9.5 17l2.5 2.5 2.5-2.5 9.4-9.4-2.5-2.5-9.4 9.4-9.4-9.4z"/>
                    </svg>
                </button>
            </div>
        </header>
        <ul class="fl-days">
            <li>Mo</li>
            <li>Di</li>
            <li>Mi</li>
            <li>Do</li>
            <li>Fr</li>
            <li>Sa</li>
            <li>So</li>
        </ul>
        <ul class="fl-events" id="days">
        </ul>
    </div>
    <script>
  const calendar = document.getElementById("calendar");
  const date = document.getElementById("date");
  const days = document.getElementById("days");

  const backward = document.getElementById("backward");
  const forward = document.getElementById("forward");

  const months = [
    "Januar",
    "Februar",
    "Maerz",
    "April",
    "Mai",
    "Juni",
    "Juli",
    "August",
    "September",
    "Oktober",
    "November",
    "Dezember",
  ];

  const weekdays = [
    "Sonntag",
    "Montag",
    "Dienstag",
    "Mittwoch",
    "Donnerstag",
    "Freitag",
    "Samstag",
  ];

  let events = [];

  let year = new Date().getFullYear();
  let month_number = new Date().getMonth();
  let month_string = months[month_number];

  function daysInMonth(year, month) {
    return new Date(year, month, 0).getDate();
  }

  const firstDayInMonthIndex = (monthIndex, year) => {
    const index = new Date(`${year}-${monthIndex + 1}-01`).getDay();
    if (index == 0) {
      return 6;
    }
    return index - 1;
  };

  const handleChange = (event) => {
    if (event.target.id == "forward") {
      month_number += 1;
    } else {
      month_number -= 1;
    }

    if (month_number == 12) {
      year += 1;
      month_number = 0;
    }

    if (month_number == -1) {
      year -= 1;
      month_number = 11;
    }
    month_string = months[month_number];
    createCalendar();
  };

  const getCSRF = () => {
    let str = document.cookie;
    str = str.split("; ");
    const result = {};
    for (let i in str) {
      const cur = str[i].split("=");
      result[cur[0]] = cur[1];
    }
    return result.csrftoken;
  };

  const getData = async () => {
    const config = {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRF(),
      },
      body: JSON.stringify({
        year: year,
        month: month_number + 1,
      }),
    };
    try {
      const data = await fetch("{% url 'get_more_tables' %}", config);
      const json = await data.json();
      return JSON.parse(json);
    } catch (error) {
      return [];
    }
  };

  const createEvent = (events) => {
    let details = document.createElement("details");
    let summary = document.createElement("summary");
    let div = document.createElement("div");
    for (x = 0; x < events.length; x++) {
      let span = document.createElement("span");
      span.appendChild(document.createTextNode(events[x].title));
      summary.appendChild(span);

      let event = document.createElement("div");
      event.appendChild(document.createTextNode(events[x].title));

      let timeOne = document.createElement("time");
      timeOne.appendChild(document.createTextNode(events[x].timeStart));

      let timeTwo = document.createElement("time");
      timeTwo.appendChild(document.createTextNode(events[x].timeEnd));

      event.appendChild(timeOne);
      event.appendChild(timeTwo);

      div.appendChild(event);
    }
    details.appendChild(summary);
    details.appendChild(div);
    return details;
  };

  const createCalendar = async () => {
    events = await getData();
    days.innerHTML = "";
    let number = daysInMonth(year, month_number + 1);
    let test = firstDayInMonthIndex(month_number, year);
    let days_fragment = new DocumentFragment();

    for (i = 0; i < test; i++) {
      let li = document.createElement("li");
      li.classList.add("deactive");
      days_fragment.appendChild(li);
    }

    for (i = 0; i < number; i++) {
      let li = document.createElement("li");
      li.classList.add("active");
      days_fragment.appendChild(li);

      if (events[i].length != 0) {
        li.appendChild(createEvent(events[i]));
      }
    }
    days.appendChild(days_fragment);
    updateDate();
  };

  const updateDate = () => {
    date.innerHTML = month_string + " " + year;
  };

  window.addEventListener("load", createCalendar);

  forward.addEventListener("click", handleChange);
  backward.addEventListener("click", handleChange);
    </script>
{% endblock content %}
