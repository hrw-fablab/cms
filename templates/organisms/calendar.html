{% load wagtailcore_tags %} {% block content %}
<div class="content calendar" id="calendar" data-width="large">
  <header class="margin" data-margin="block-end" data-margin-size="tiny">
    <time id="date"></time>
    <div class="flex gap" data-gap="small">
      <button id="backward">
        <svg width="18" height="18" viewBox="0 0 24 24" transform="rotate(90)">
          <path
            d="M2.6 5.1.1 7.6 9.5 17l2.5 2.5 2.5-2.5 9.4-9.4-2.5-2.5-9.4 9.4-9.4-9.4z"
          />
        </svg>
      </button>
      <button id="forward">
        <svg width="18" height="18" viewBox="0 0 24 24" transform="rotate(-90)">
          <path
            d="M2.6 5.1.1 7.6 9.5 17l2.5 2.5 2.5-2.5 9.4-9.4-2.5-2.5-9.4 9.4-9.4-9.4z"
          />
        </svg>
      </button>
    </div>
  </header>
  <ol class="days">
    <li>Mo</li>
    <li>Di</li>
    <li>Mi</li>
    <li>Do</li>
    <li>Fr</li>
    <li>Sa</li>
    <li>So</li>
  </ol>
  <ol class="events" id="events"> </ol>
</div>
<script>
  const calendar = document.getElementById("calendar");
  const date = document.getElementById("date");
  const events = document.getElementById("events");

  const backward = document.getElementById("backward");
  const forward = document.getElementById("forward");
  let elements = document.getElementsByTagName("details");

  const months = [
    "Januar",
    "Februar",
    "Maerz",
    "April",
    "Mai",
    "Juni",
    "Juli",
    "August",
    "September",
    "Oktober",
    "November",
    "Dezember",
  ];

  const weekdays = [
    "Sonntag",
    "Montag",
    "Dienstag",
    "Mittwoch",
    "Donnerstag",
    "Freitag",
    "Samstag",
  ];

  const categorys = ["none", "teach", "open", "student", "workshop", "external"];

  let year = new Date().getFullYear();
  let month_number = new Date().getMonth();
  let month_string = months[month_number];

  function daysInMonth(year, month) {
    return new Date(year, month, 0).getDate();
  }

  const firstDayInMonthIndex = (monthIndex, year) => {
    const index = new Date(`${year}-${monthIndex + 1}-01`).getDay();
    if (index == 0) {
      return 6;
    }
    return index - 1;
  };

  const handleChange = (event) => {
    if (event.target.id == "forward") {
      month_number += 1;
    } else {
      month_number -= 1;
    }

    if (month_number == 12) {
      year += 1;
      month_number = 0;
    }

    if (month_number == -1) {
      year -= 1;
      month_number = 11;
    }
    month_string = months[month_number];
    createCalendar();
  };

  const getCSRF = () => {
    let str = document.cookie;
    str = str.split("; ");
    const result = {};
    for (let i in str) {
      const cur = str[i].split("=");
      result[cur[0]] = cur[1];
    }
    return result.csrftoken;
  };

  const getData = async () => {
    const config = {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRF(),
      },
      body: JSON.stringify({
        year: year,
        month: month_number + 1,
      }),
    };
    try {
      const data = await fetch("{% url 'get_events' %}", config);
      const json = await data.json();
      return JSON.parse(json);
    } catch (error) {
      return [];
    }
  };

  const createEvent = (events) => {
    let events_fragment = new DocumentFragment();
    for (x = 0; x < events.length; x++) {
      let details = document.createElement("details");
      details.className = "cl-details";
      details.dataset.type = categorys[events[x].category];

      details.innerHTML = `
      <summary>
        <span class="date">${events[x].day} ${months[month_number]}</span>
        <span class="overview">
          <span class="time">
            <time>${events[x].timeStart}</time>
            <time>${events[x].timeEnd}</time>
          </span>
          ${events[x].title}
        </span>
      </summary>
      <div>
        <p>${events[x].description}</p>
        <a href="${events[x].link}">${events[x].link_text}</>
      </div>
      `;

      events_fragment.appendChild(details);
    }

    return events_fragment;
  };

  const createCalendar = async () => {
    data = await getData();
    events.innerHTML = "";
    let number = daysInMonth(year, month_number + 1);
    let test = firstDayInMonthIndex(month_number, year);
    let days_fragment = new DocumentFragment();

    for (i = 0; i < test; i++) {
      let li = document.createElement("li");
      li.setAttribute("id", i);
      li.classList.add("deactive");
      days_fragment.appendChild(li);
    }

    for (i = 0; i < number; i++) {
      let li = document.createElement("li");
      li.setAttribute("id", i + test);
      li.classList.add("active");

      if (data[i].length != 0) {
        li.classList.add("full");
        li.appendChild(createEvent(data[i]));
      }

      days_fragment.appendChild(li);
    }
    events.appendChild(days_fragment);
    updateDate();
  };

  const updateDate = () => {
    date.innerHTML = month_string + " " + year;
  };

  let old_target = null;

  const details = document.getElementsByTagName("details");
  document.addEventListener("click", () => {
    Array.from(details).forEach((element) => element.removeAttribute("open"));
  });

  window.addEventListener("load", createCalendar);

  forward.addEventListener("click", handleChange);
  backward.addEventListener("click", handleChange);
</script>
{% endblock content %}
